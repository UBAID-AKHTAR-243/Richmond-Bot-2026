<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Enabled Chat Interface</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --whatsapp-green: #00a884;
            --whatsapp-green-hover: #00ba8e;
            --whatsapp-green-active: #009774;
            --whatsapp-dark-bg: #0c1317;
            --whatsapp-chat-bg: #111b21;
            --whatsapp-panel-bg: #202c33;
            --whatsapp-message-out: #005c4b;
            --whatsapp-message-in: #202c33;
            --whatsapp-text-primary: #e9edef;
            --whatsapp-text-secondary: #8696a0;
            --whatsapp-border: #222e35;
            --whatsapp-online: #00a884;
            --whatsapp-typing: #00a884;
            --whatsapp-notification: #ff3b30;
            --voice-button-active: #ff3b30;
            --send-button-red: #ff3b30;
            --blue-tick: #53bdeb;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--whatsapp-dark-bg);
            color: var(--whatsapp-text-primary);
            height: 100vh;
            overflow: hidden;
            padding-bottom: 100px;
        }
        
        /* Main Container */
        .whatsapp-container {
            display: flex;
            height:80%;
            max-width: 1200px;
            margin: 0 auto;
            background:0067C32;
        }
        
        /* Right Panel - Chat Window */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--whatsapp-chat-bg);
            position: relative;
            width: 100%;
            height: 80vh;
        }
        
        /* Chat Header */
        .chat-header {
            padding: 10px 20px;
            background: var(--whatsapp-panel-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            border-bottom: 1px solid var(--whatsapp-border);
        }
        
        .contact-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--whatsapp-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            overflow: hidden;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .contact-info h2 {
            font-size: 16px;
            font-weight: 500;
        }
        
        .contact-status {
            font-size: 13px;
            color: var(--whatsapp-text-secondary);
        }
        
        .contact-status.online {
            color: var(--whatsapp-online);
        }
        
        .contact-status.offline {
            color: var(--whatsapp-text-secondary);
        }
        
        .chat-header-icons {
            display: flex;
            gap: 25px;
            color: var(--whatsapp-text-secondary);
        }
        
        .chat-header-icons i {
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .chat-header-icons i:hover {
            color: var(--whatsapp-text-primary);
        }
        
        /* Messages Area */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23111b21'/%3E%3Cpath d='M0 50L50 0L100 50L50 100Z' fill='%23141e25' opacity='0.2'/%3E%3C/svg%3E");
            background-size: 100px;
        }
        
        .message-day {
            text-align: center;
            margin: 20px 0;
            color: var(--whatsapp-text-secondary);
            font-size: 12px;
            position: relative;
        }
        
        .message-day span {
            background: var(--whatsapp-panel-bg);
            padding: 5px 12px;
            border-radius: 15px;
        }
        
        .message {
            max-width: 65%;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .message.outgoing {
            margin-left: auto;
            align-items: flex-end;
        }
        
        .message.incoming {
            margin-right: auto;
            align-items: flex-start;
        }
        
        .message-bubble {
            padding: 8px 12px;
            border-radius: 8px;
            position: relative;
            max-width: 100%;
            word-wrap: break-word;
        }
        
        .message.outgoing .message-bubble {
            background: var(--whatsapp-message-out);
            border-top-right-radius: 0;
        }
        
        .message.incoming .message-bubble {
            background: var(--whatsapp-message-in);
            border-top-left-radius: 0;
        }
        
        .message-text {
            font-size: 14px;
            line-height: 1.4;
        }
        
        /* UPDATED: Message time and two tick marks */
        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 3px;
        }
        
        .message.incoming .message-time {
            color: rgba(255, 255, 255, 0.5);
            justify-content: flex-start;
        }
        
        /* Two tick marks for outgoing messages */
        .double-tick {
            display: flex;
            align-items: center;
            gap: 1px;
        }
        
        .double-tick i {
            font-size: 10px;
        }
        
        .double-tick.blue i {
            color: var(--blue-tick) !important;
        }
        
        /* Voice Message Styles */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.2s;
            min-width: 150px;
            margin-top: 5px;
        }
        
        .voice-message:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .voice-play-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--whatsapp-green);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 2;
        }
        
        .voice-waveform {
            flex: 1;
            height: 30px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .voice-waveform-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: var(--whatsapp-green);
            border-radius: 15px;
            transition: width 0.1s linear;
        }
        
        .voice-duration {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            min-width: 40px;
            text-align: right;
            background: transparent;
        }
        
        /* Audio player */
        .audio-attachment {
            max-width: 300px;
            margin-top: 5px;
        }
        
        .audio-player {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
            position: relative;
        }
        
        .audio-play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--whatsapp-green);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            z-index: 2;
        }
        
        .audio-play-btn:hover {
            background: var(--whatsapp-green-hover);
        }
        
        .audio-play-btn.playing {
            background: var(--voice-button-active);
        }
        
        .audio-info {
            flex: 1;
            min-width: 0;
        }
        
        .audio-title {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        
        .audio-duration {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            background: transparent;
        }
        
        .audio-waveform {
            width: 80px;
            height: 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .audio-waveform-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: var(--whatsapp-green);
            border-radius: 10px;
            transition: width 0.1s linear;
        }
        
        .audio-download-btn {
            background: transparent;
            border: none;
            color: var(--whatsapp-text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .audio-download-btn:hover {
            color: var(--whatsapp-text-primary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Image attachment - FIXED: Small fixed size initially */
        .image-attachment {
            max-width: 200px;
            margin-top: 5px;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
        }
        
        .image-attachment img {
            width: 100%;
            height: 150px; /* Fixed small size */
            object-fit: cover;
            border-radius: 8px;
            transition: transform 0.3s;
        }
        
        .image-attachment img:hover {
            transform: scale(1.02);
        }
        
        .file-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            font-size: 12px;
        }
        
        .file-name {
            color: var(--whatsapp-text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 150px;
        }
        
        .file-actions {
            display: flex;
            gap: 5px;
        }
        
        .file-action-btn {
            background: transparent;
            border: none;
            color: var(--whatsapp-text-secondary);
            cursor: pointer;
            padding: 3px;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .file-action-btn:hover {
            color: var(--whatsapp-text-primary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Input Area */
        .input-container {
            padding: 15px 20px;
            background: var(--whatsapp-panel-bg);
            display: flex;
            align-items: flex-end;
            gap: 10px;
            min-height: 70px;
            border-top: 1px solid var(--whatsapp-border);
        }
        
        .message-input-wrapper {
            flex: 1;
            background: var(--whatsapp-chat-bg);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            padding: 8px 12px;
            min-height: 40px;
            max-height: 200px;
            transition: all 0.3s ease;
        }
        
        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--whatsapp-text-primary);
            font-size: 15px;
            outline: none;
            resize: none;
            width: 100%;
            min-height: 14px;
            max-height: 20px;
            font-family: inherit;
            line-height: 1.4;
            overflow-y: auto;
        }
        
        .message-input::placeholder {
            color: var(--whatsapp-text-secondary);
        }
        
        .input-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            align-items: center;
            justify-content: space-between;
        }
        
        .attach-button-circle {
            width: 36px;
            height: 36px;
            background: var(--whatsapp-green);
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .attach-button-circle:hover {
            background: var(--whatsapp-green-hover);
            transform: scale(1.05);
        }
        
        .voice-buttons-group {
            display: flex;
            gap: 8px;
        }
        
        .voice-button {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            border-radius: 50%;
            color: var(--whatsapp-text-secondary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .voice-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--whatsapp-text-primary);
        }
        
        .voice-button.active {
            background: var(--voice-button-active);
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        .voice-button.listening {
            background: var(--whatsapp-green);
            color: white;
            animation: pulse-green 1.5s infinite;
        }
        
        .send-button-voice {
            width: 36px;
            height: 36px;
            background: var(--send-button-red);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            opacity: 0;
            transform: scale(0);
        }
        
        .send-button-voice.visible {
            opacity: 1;
            transform: scale(1);
        }
        
        .send-button-voice:hover {
            background: #ff2b20;
        }
        
        .send-button-voice i {
            font-size: 16px;
            transform: rotate(90deg);
        }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(0, 168, 132, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 168, 132, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 168, 132, 0); }
        }
        
        /* Recording Indicator */
        .recording-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: var(--voice-button-active);
            font-size: 14px;
            margin-top: 10px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .recording-indicator.active {
            display: flex;
        }
        
        .recording-dot {
            width: 8px;
            height: 8px;
            background: var(--voice-button-active);
            border-radius: 50%;
        }
        
        /* Listening Indicator */
        .listening-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: var(--whatsapp-green);
            font-size: 14px;
            margin-top: 10px;
        }
        
        .listening-indicator.active {
            display: flex;
        }
        
        .listening-dot {
            width: 8px;
            height: 8px;
            background: var(--whatsapp-green);
            border-radius: 50%;
            animation: pulse-green 1.5s infinite;
        }
        
        /* Image Modal - UPDATED for full screen */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            cursor: pointer;
        }
        
        .image-modal.active {
            display: flex;
        }
        
        .image-modal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            padding: 20px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--whatsapp-border);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--whatsapp-text-secondary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .whatsapp-container {
                max-width: 100%;
                height: 100vh;
            }
            
            .chat-header {
                padding: 10px 15px;
            }
            
            .messages-container {
                padding: 15px;
            }
            
            .input-container {
                padding: 12px 15px;
            }
            
            .message {
                max-width: 85%;
            }
            
            .image-attachment {
                max-width: 180px;
            }
            
            .image-attachment img {
                height: 120px;
            }
            
            .audio-attachment {
                max-width: 250px;
            }
        }
        
        /* Added for video attachment */
        .video-attachment {
            max-width: 200px;
            margin-top: 5px;
        }
        
        .video-player-container {
            position: relative;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .video-player-container video {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: none;
        }
        
        .video-player-container video[controls] {
            display: block;
        }
        
        .video-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        
        .video-meta {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Chat Interface -->
    <div class="whatsapp-container">
        <!-- Right Panel - Chat Window -->
        <div class="chat-container" id="chatContainer">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="contact-info">
                    <div class="avatar" id="contactAvatar">
                        <!-- Company Logo Image -->
                        <img src="rich.jpg" alt="Richmond Pharmaceutical Logo" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-building\'></i>';">
                    </div>
                    <div>
                        <h2 id="contactName">Richmond's Assistant</h2>
                        <p class="contact-status online" id="contactStatus">Online</p>
                    </div>
                </div>
                <div class="chat-header-icons">
                    <i class="fas fa-plus" id="newChatButton" title="Start new chat"></i>
                </div>
            </div>
            
            <!-- Messages Area -->
            <div class="messages-container" id="messagesContainer">
                <div class="message-day">
                    <span>Today</span>
                </div>
                
                <!-- Default Welcome Message -->
                <div class="message incoming" id="defaultWelcomeMessage">
                    <div class="message-bubble">
                        <div class="message-text">Welcome to Richmond Pharmaceutical! Click the microphone buttons or write below to start chat.</div>
                        <div class="message-time" id="currentTime"></div>
                    </div>
                </div>
            </div>
            
            <!-- Attached Files Preview -->
            <div class="attached-files" id="attachedFiles" style="display: true;"></div>
            
            <!-- Recording Indicator -->
            <div class="recording-indicator" id="recordingIndicator">
                <div class="recording-dot"></div>
                <span>Recording: <span id="recordingDuration">0:00</span></span>
            </div>
            
            <!-- Listening Indicator -->
            <div class="listening-indicator" id="listeningIndicator">
                <div class="listening-dot"></div>
                <span>Listening...</span>
            </div>
            
            <!-- Message Input Area -->
            <div class="input-container">
                <div class="message-input-wrapper">
                    <textarea class="message-input" id="messageInput" placeholder="Type a message" rows="1"></textarea>
                    
                    <!-- Input Buttons -->
                    <div class="input-buttons">
                        <!-- Attach button as circle -->
                        <button class="attach-button-circle" id="attachButton" title="Attach file">
                            <i class="fas fa-plus"></i>
                        </button>
                        
                        <!-- Voice and Send buttons on extreme right -->
                        <div class="voice-buttons-group">
                            <!-- Voice to Voice button -->
                            <button class="voice-button" id="voiceToVoice" title="Voice Message">
                                <i class="fas fa-microphone-alt"></i>
                            </button>
                            <!-- Voice to Text button -->
                            <button class="voice-button" id="voiceToText" title="Voice to Text">
                                <i class="fas fa-wave-square"></i>
                            </button>
                            <!-- Send button with upward arrow -->
                            <button class="send-button-voice" id="sendButton" title="Send message">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="fileInput" accept="audio/*,video/*,image/*,.pdf,.doc,.docx,.txt" multiple style="display: none;">

    <!-- Audio elements for playing messages -->
    <audio id="voicePlayer" style="display: none;"></audio>
    
    <!-- Image Modal -->
    <div class="image-modal" id="imageModal">
        <img src="" alt="Enlarged Image">
    </div>

    <script>
        // DOM Elements
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const voiceToVoiceBtn = document.getElementById('voiceToVoice');
        const voiceToTextBtn = document.getElementById('voiceToText');
        const attachButton = document.getElementById('attachButton');
        const fileInput = document.getElementById('fileInput');
        const attachedFilesContainer = document.getElementById('attachedFiles');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const listeningIndicator = document.getElementById('listeningIndicator');
        const contactStatus = document.getElementById('contactStatus');
        const defaultWelcomeMessage = document.getElementById('defaultWelcomeMessage');
        const voicePlayer = document.getElementById('voicePlayer');
        const newChatButton = document.getElementById('newChatButton');
        const imageModal = document.getElementById('imageModal');
        const recordingDurationEl = document.getElementById('recordingDuration');

        // State
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let attachedFiles = [];
        let recordingTimer = null;
        let durationInterval = null;
        let isFirstMessage = true;
        let currentlyPlayingMessage = null;
        let currentPlayingAudio = null;
        let recordingStartTime = null;
        let recordingDuration = 0;
        
        // Speech Recognition
        let recognition = null;
        let isSpeechRecognitionSupported = false;
        let isListening = false;
        
        // Audio stream for recording
        let audioStream = null;

        // Initialize Speech Recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                isSpeechRecognitionSupported = true;
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = () => {
                    console.log('Speech recognition started');
                    isListening = true;
                    voiceToTextBtn.classList.add('listening');
                    listeningIndicator.classList.add('active');
                };
                
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    if (finalTranscript) {
                        messageInput.value = finalTranscript;
                    } else if (interimTranscript) {
                        messageInput.value = interimTranscript;
                    }
                    
                    if (messageInput.value.trim()) {
                        sendButton.classList.add('visible');
                    }
                };
                
                recognition.onend = () => {
                    console.log('Speech recognition ended');
                    if (isListening) {
                        setTimeout(() => {
                            if (isListening) {
                                try {
                                    recognition.start();
                                } catch (e) {
                                    console.log('Could not restart recognition:', e);
                                }
                            }
                        }, 100);
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    if (event.error === 'no-speech') {
                        return;
                    }
                    stopVoiceToText();
                };
            } else {
                console.warn('Speech recognition not supported');
                isSpeechRecognitionSupported = false;
            }
        }

        // Initialize
        function init() {
            setupEventListeners();
            adjustTextareaHeight();
            updateCurrentTime();
            setOnlineStatus();
            initSpeechRecognition();
            
            window.addEventListener('online', setOnlineStatus);
            window.addEventListener('offline', setOfflineStatus);
        }

        // Setup Event Listeners
        function setupEventListeners() {
            sendButton.addEventListener('click', sendMessage);
            
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (messageInput.value.trim() || attachedFiles.length > 0) {
                        sendMessage();
                    }
                }
                setTimeout(adjustTextareaHeight, 0);
            });
            
            messageInput.addEventListener('input', () => {
                const hasText = messageInput.value.trim().length > 0 || attachedFiles.length > 0;
                if (hasText) {
                    sendButton.classList.add('visible');
                } else {
                    sendButton.classList.remove('visible');
                }
                adjustTextareaHeight();
            });
            
            voiceToVoiceBtn.addEventListener('click', toggleVoiceRecording);
            
            voiceToTextBtn.addEventListener('click', toggleVoiceToText);
            
            attachButton.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', handleFileSelect);
            
            newChatButton.addEventListener('click', startNewChat);
            
            voicePlayer.addEventListener('ended', () => {
                stopAudioPlayback();
            });
            
            voicePlayer.addEventListener('pause', () => {
                stopAudioPlayback();
            });
            
            voicePlayer.addEventListener('timeupdate', () => {
                updateAudioProgress();
            });
            
            imageModal.addEventListener('click', () => {
                imageModal.classList.remove('active');
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && imageModal.classList.contains('active')) {
                    imageModal.classList.remove('active');
                }
            });
        }

        // Set online status
        function setOnlineStatus() {
            contactStatus.textContent = 'Online';
            contactStatus.className = 'contact-status online';
        }

        // Set offline status
        function setOfflineStatus() {
            contactStatus.textContent = 'Offline';
            contactStatus.className = 'contact-status offline';
        }

        // Start new chat
        function startNewChat() {
            const messages = messagesContainer.querySelectorAll('.message:not(#defaultWelcomeMessage), .message-day');
            messages.forEach(msg => msg.remove());
            
            isFirstMessage = true;
            attachedFiles = [];
            attachedFilesContainer.style.display = 'none';
            attachedFilesContainer.innerHTML = '';
            messageInput.value = '';
            sendButton.classList.remove('visible');
            stopVoiceToText();
            
            defaultWelcomeMessage.style.display = 'flex';
            
            updateCurrentTime();
            messagesContainer.scrollTop = 0;
        }

        // Adjust textarea height
        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            const newHeight = Math.min(messageInput.scrollHeight, 150);
            messageInput.style.height = newHeight + 'px';
            
            const wrapper = messageInput.parentElement;
            wrapper.style.minHeight = Math.max(40, newHeight + 70) + 'px';
        }

        // Update current time
        function updateCurrentTime() {
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes();
                timeElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }
        }

        // Send Message
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text && attachedFiles.length === 0) return;
            
            if (isFirstMessage) {
                defaultWelcomeMessage.style.display = 'none';
                isFirstMessage = false;
            }
            
            const message = {
                id: Date.now(),
                type: 'outgoing',
                text: text,
                time: getCurrentTime(),
                status: 'sent',
                files: [...attachedFiles],
                isTextMessage: text.length > 0
            };
            
            addMessageToUI(message);
            
            messageInput.value = '';
            attachedFiles = [];
            attachedFilesContainer.style.display = 'none';
            attachedFilesContainer.innerHTML = '';
            sendButton.classList.remove('visible');
            adjustTextareaHeight();
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            setTimeout(() => {
                simulateReply(message.isTextMessage, attachedFiles.length > 0);
            }, 1500);
        }

        // Add Message to UI
        function addMessageToUI(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.type}`;
            messageDiv.dataset.id = message.id;
            
            let messageContent = '';
            
            if (message.text) {
                messageContent += `<div class="message-text">${message.text}</div>`;
            }
            
            if (message.voiceUrl) {
                messageContent += `
                    <div class="voice-message" onclick="playVoiceMessage('${message.id}')" data-audio-url="${message.voiceUrl}">
                        <div class="voice-play-button" id="play-btn-${message.id}">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="voice-waveform" id="waveform-${message.id}">
                            <div class="voice-waveform-progress" id="waveform-progress-${message.id}"></div>
                        </div>
                        <div class="voice-duration">${message.voiceDuration || '0:00'}</div>
                    </div>
                `;
            }
            
            if (message.files && message.files.length > 0) {
                message.files.forEach(file => {
                    messageContent += addFileAttachment(file, message.id);
                });
            }
            
            // Two tick marks for outgoing messages
            const tickMarks = message.type === 'outgoing' ? 
                '<div class="double-tick" id="ticks-' + message.id + '"><i class="fas fa-check"></i><i class="fas fa-check"></i></div>' : '';
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${messageContent}
                    <div class="message-time">${message.time} ${tickMarks}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            // Turn tick marks blue after 1 second for outgoing messages
            if (message.type === 'outgoing') {
                setTimeout(() => {
                    const tickElement = document.getElementById(`ticks-${message.id}`);
                    if (tickElement) {
                        tickElement.classList.add('blue');
                    }
                }, 1000);
            }
        }

        // Add File Attachment to UI
        function addFileAttachment(file, messageId) {
            const fileIcon = getFileIcon(file.type);
            const fileSize = formatFileSize(file.size);
            const uniqueId = `${messageId}-${Date.now()}`;
            
            let attachmentHtml = '';
            
            if (file.type.includes('image')) {
                attachmentHtml = `
                    <div class="image-attachment">
                        <img src="${file.content}" alt="${file.name}" onclick="openImageModal('${file.name}', '${file.content}')">
                        <div class="file-meta">
                            <span class="file-name">${file.name}</span>
                            <div class="file-actions">
                                <button class="file-action-btn" onclick="downloadFile('${file.name}', '${file.content}')" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (file.type.includes('audio')) {
                attachmentHtml = `
                    <div class="audio-attachment">
                        <div class="audio-player">
                            <button class="audio-play-btn" onclick="playAudioAttachment('${uniqueId}', '${file.content}')" id="audio-btn-${uniqueId}">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="audio-info">
                                <div class="audio-title">${file.name}</div>
                                <div class="audio-duration" id="audio-duration-${uniqueId}">0:30</div>
                            </div>
                            <div class="audio-waveform" id="waveform-${uniqueId}">
                                <div class="audio-waveform-progress" id="audio-progress-${uniqueId}"></div>
                            </div>
                            <button class="audio-download-btn" onclick="downloadFile('${file.name}', '${file.content}')" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                `;
            } else if (file.type.includes('video')) {
                attachmentHtml = `
                    <div class="video-attachment">
                        <div class="video-player-container">
                            <video id="video-${uniqueId}" preload="metadata">
                                <source src="${file.content}" type="${file.type}">
                                Your browser does not support the video tag.
                            </video>
                            <button class="video-play-btn" onclick="playVideoAttachment('${uniqueId}')">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                        <div class="video-meta">
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">${fileSize}</span>
                        </div>
                    </div>
                `;
            } else {
                attachmentHtml = `
                    <div class="file-attachment">
                        <div class="file-icon">
                            <i class="${fileIcon}"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${fileSize}</div>
                        </div>
                        <div class="file-download" onclick="downloadFile('${file.name}', '${file.content}')" title="Download">
                            <i class="fas fa-download"></i>
                        </div>
                    </div>
                `;
            }
            
            return attachmentHtml;
        }

        // Toggle Voice Recording - FIXED
        async function toggleVoiceRecording() {
            if (!isRecording) {
                await startVoiceRecording();
            } else {
                stopVoiceRecording();
            }
        }

        // Start Voice Recording - FIXED to work properly
        async function startVoiceRecording() {
            try {
                // Stop any existing recording first
                if (isRecording) {
                    stopVoiceRecording();
                    return;
                }
                
                // Request microphone access
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });
                
                // Create MediaRecorder with proper MIME type
                const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 
                    'audio/webm;codecs=opus' : 
                    MediaRecorder.isTypeSupported('audio/mp4') ? 
                    'audio/mp4' : '';
                
                if (!mimeType) {
                    throw new Error('No supported audio format found');
                }
                
                mediaRecorder = new MediaRecorder(audioStream, { mimeType });
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    // Create audio blob from chunks
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Only add message if recording duration is at least 0.5 seconds
                    if (audioChunks.length > 0 && recordingDuration >= 0.5) {
                        if (isFirstMessage) {
                            defaultWelcomeMessage.style.display = 'none';
                            isFirstMessage = false;
                        }
                        
                        const message = {
                            id: Date.now(),
                            type: 'outgoing',
                            voiceUrl: audioUrl,
                            voiceDuration: formatDuration(recordingDuration),
                            time: getCurrentTime(),
                            status: 'sent',
                            isTextMessage: false
                        };
                        
                        addMessageToUI(message);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        
                        setTimeout(() => {
                            simulateReply(false, false);
                        }, 1500);
                    } else if (recordingDuration < 0.5) {
                        alert("Recording too short. Please record at least half a second.");
                    }
                    
                    // Stop all tracks
                    if (audioStream) {
                        audioStream.getTracks().forEach(track => track.stop());
                        audioStream = null;
                    }
                };
                
                mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder error:', event.error);
                    stopVoiceRecording();
                    alert('Error recording audio. Please try again.');
                };
                
                // Start recording
                mediaRecorder.start(100); // Collect data every 100ms
                voiceToVoiceBtn.classList.add('active');
                recordingIndicator.classList.add('active');
                isRecording = true;
                recordingStartTime = Date.now();
                recordingDuration = 0;
                recordingDurationEl.textContent = '0:00';
                
                // Stop recording after 60 seconds
                recordingTimer = setTimeout(() => {
                    if (isRecording) {
                        stopVoiceRecording();
                    }
                }, 60000);
                
                // Update duration every second
                durationInterval = setInterval(() => {
                    if (isRecording) {
                        recordingDuration = Math.floor((Date.now() - recordingStartTime) / 1000);
                        const seconds = recordingDuration % 60;
                        const minutes = Math.floor(recordingDuration / 60);
                        recordingDurationEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please check permissions and try again.');
                isRecording = false;
                voiceToVoiceBtn.classList.remove('active');
            }
        }

        // Stop Voice Recording - FIXED
        function stopVoiceRecording() {
            if (mediaRecorder && isRecording) {
                try {
                    mediaRecorder.stop();
                } catch (e) {
                    console.log('Error stopping recorder:', e);
                }
            }
            
            // Clear timers
            clearTimeout(recordingTimer);
            clearInterval(durationInterval);
            
            // Update UI
            voiceToVoiceBtn.classList.remove('active');
            recordingIndicator.classList.remove('active');
            isRecording = false;
            recordingDuration =10;
            recordingStartTime = null;
            
            // Stop audio stream if it exists
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
        }

        // Format duration
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Toggle Voice to Text
        function toggleVoiceToText() {
            if (!isListening) {
                startVoiceToText();
            } else {
                stopVoiceToText();
            }
        }

        // Start Voice to Text
        function startVoiceToText() {
            if (!isSpeechRecognitionSupported) {
                alert('Speech recognition is not supported in your browser. Please type your message instead.');
                return;
            }
            
            if (recognition) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error starting speech recognition:', error);
                }
            }
        }

        // Stop Voice to Text
        function stopVoiceToText() {
            if (recognition && isListening) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.error('Error stopping speech recognition:', error);
                }
            }
            
            voiceToTextBtn.classList.remove('listening');
            listeningIndicator.classList.remove('active');
            isListening = false;
        }

        // Handle File Selection
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    attachedFiles.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        content: e.target.result
                    });
                    updateAttachedFilesUI();
                    
                    sendButton.classList.add('visible');
                };
                reader.readAsDataURL(file);
            });
            
            fileInput.value = '';
        }

        // Update Attached Files UI
        function updateAttachedFilesUI() {
            if (attachedFiles.length === 0) {
                attachedFilesContainer.style.display = 'none';
                return;
            }
            
            attachedFilesContainer.style.display = 'flex';
            attachedFilesContainer.innerHTML = '';
            
            attachedFiles.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'attached-file';
                fileDiv.innerHTML = `
                    <i class="${getFileIcon(file.type)}"></i>
                    <span>${file.name}</span>
                    <span class="remove-file" onclick="removeAttachedFile(${index})">
                        <i class="fas fa-times"></i>
                    </span>
                `;
                attachedFilesContainer.appendChild(fileDiv);
            });
        }

        // Remove Attached File
        function removeAttachedFile(index) {
            attachedFiles.splice(index, 1);
            updateAttachedFilesUI();
            
            if (attachedFiles.length === 0 && messageInput.value.trim().length === 0) {
                sendButton.classList.remove('visible');
            }
        }

        // Get File Icon
        function getFileIcon(fileType) {
            if (fileType.includes('audio')) return 'fas fa-file-audio';
            if (fileType.includes('video')) return 'fas fa-file-video';
            if (fileType.includes('image')) return 'fas fa-file-image';
            if (fileType.includes('pdf')) return 'fas fa-file-pdf';
            if (fileType.includes('word') || fileType.includes('document')) return 'fas fa-file-word';
            return 'fas fa-file';
        }

        // Format File Size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Simulate Reply
        function simulateReply(isTextMessage, hasFiles) {
            if (isTextMessage || hasFiles) {
                const replies = [
                    "I received your message! How can I help you further?",
                    "Thanks for your message! Is there anything else you need?",
                    "Can you explain that in more detail?",
                    "I'll get back to you on that shortly.",
                    "That's interesting! Tell me more about it."
                ];
                
                const randomReply = replies[Math.floor(Math.random() * replies.length)];
                
                const message = {
                    id: Date.now(),
                    type: 'incoming',
                    text: randomReply,
                    time: getCurrentTime(),
                    isTextMessage: true
                };
                
                addMessageToUI(message);
            } else {
                // Simulate voice reply
                const message = {
                    id: Date.now(),
                    type: 'incoming',
                    voiceUrl: '#', // This would be a real voice URL in production
                    voiceDuration: '0:18',
                    time: getCurrentTime(),
                    isTextMessage: false
                };
                
                addMessageToUI(message);
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Play Voice Message - FIXED
        function playVoiceMessage(messageId) {
            const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
            if (!messageElement) return;
            
            const audioUrl = messageElement.querySelector('.voice-message').dataset.audioUrl;
            if (!audioUrl) return;
            
            // If the same message is already playing, pause it
            if (currentlyPlayingMessage === messageId) {
                if (!voicePlayer.paused) {
                    voicePlayer.pause();
                    updatePlayButton(messageId, false);
                    currentlyPlayingMessage = null;
                }
                return;
            }
            
            // If another message is playing, stop it
            if (currentlyPlayingMessage) {
                voicePlayer.pause();
                updatePlayButton(currentlyPlayingMessage, false);
                resetProgressBar(currentlyPlayingMessage);
            }
            
            // Set up the audio player
            voicePlayer.src = audioUrl;
            currentlyPlayingMessage = messageId;
            
            voicePlayer.play().then(() => {
                updatePlayButton(messageId, true);
            }).catch(e => {
                console.error('Error playing audio:', e);
                alert('Error playing audio. The audio format might not be supported.');
                currentlyPlayingMessage = null;
            });
        }

        // Update play button state
        function updatePlayButton(messageId, isPlaying) {
            const playButton = document.querySelector(`#play-btn-${messageId} i`);
            if (playButton) {
                if (isPlaying) {
                    playButton.classList.remove('fa-play');
                    playButton.classList.add('fa-pause');
                } else {
                    playButton.classList.remove('fa-pause');
                    playButton.classList.add('fa-play');
                }
            }
        }

        // Reset progress bar
        function resetProgressBar(messageId) {
            const progressBar = document.getElementById(`waveform-progress-${messageId}`);
            if (progressBar) {
                progressBar.style.width = '0%';
            }
        }

        // Update Audio Progress
        function updateAudioProgress() {
            if (!voicePlayer.duration || voicePlayer.duration === Infinity) return;
            
            const progress = (voicePlayer.currentTime / voicePlayer.duration) * 100;
            
            if (currentlyPlayingMessage) {
                const progressBar = document.getElementById(`waveform-progress-${currentlyPlayingMessage}`);
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
            }
            
            if (currentPlayingAudio) {
                const progressBar = document.getElementById(`audio-progress-${currentPlayingAudio}`);
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
            }
        }

        // Stop Audio Playback
        function stopAudioPlayback() {
            if (currentlyPlayingMessage) {
                updatePlayButton(currentlyPlayingMessage, false);
                resetProgressBar(currentlyPlayingMessage);
                currentlyPlayingMessage = null;
            }
            
            if (currentPlayingAudio) {
                const playBtn = document.querySelector(`#audio-btn-${currentPlayingAudio} i`);
                const progressBar = document.getElementById(`audio-progress-${currentPlayingAudio}`);
                
                if (playBtn) {
                    playBtn.classList.remove('fa-pause');
                    playBtn.classList.add('fa-play');
                }
                if (progressBar) {
                    progressBar.style.width = '0%';
                }
                currentPlayingAudio = null;
            }
            
            voicePlayer.pause();
            voicePlayer.currentTime = 0;
        }

        // Play Audio Attachment - FIXED
        function playAudioAttachment(uniqueId, content) {
            const playBtn = document.querySelector(`#audio-btn-${uniqueId} i`);
            
            // If the same audio is already playing, pause it
            if (currentPlayingAudio === uniqueId) {
                if (!voicePlayer.paused) {
                    voicePlayer.pause();
                    if (playBtn) {
                        playBtn.classList.remove('fa-pause');
                        playBtn.classList.add('fa-play');
                    }
                    currentPlayingAudio = null;
                }
                return;
            }
            
            // If another audio is playing, stop it
            if (currentPlayingAudio) {
                const prevPlayBtn = document.querySelector(`#audio-btn-${currentPlayingAudio} i`);
                const prevProgressBar = document.getElementById(`audio-progress-${currentPlayingAudio}`);
                if (prevPlayBtn) {
                    prevPlayBtn.classList.remove('fa-pause');
                    prevPlayBtn.classList.add('fa-play');
                }
                if (prevProgressBar) {
                    prevProgressBar.style.width = '0%';
                }
                voicePlayer.pause();
            }
            
            // Play the selected audio
            currentPlayingAudio = uniqueId;
            voicePlayer.src = content;
            
            voicePlayer.play().then(() => {
                if (playBtn) {
                    playBtn.classList.remove('fa-play');
                    playBtn.classList.add('fa-pause');
                }
            }).catch(e => {
                console.error('Error playing audio:', e);
                alert('Error playing audio file. The format might not be supported.');
                currentPlayingAudio = null;
            });
        }

        // Play Video Attachment
        function playVideoAttachment(uniqueId) {
            const videoElement = document.getElementById(`video-${uniqueId}`);
            const playBtn = videoElement?.closest('.video-player-container')?.querySelector('.video-play-btn i');
            
            if (!videoElement) return;
            
            if (videoElement.paused) {
                videoElement.controls = true;
                videoElement.play().then(() => {
                    if (playBtn) {
                        playBtn.classList.remove('fa-play');
                        playBtn.classList.add('fa-pause');
                        playBtn.parentElement.style.display = 'none';
                    }
                }).catch(e => {
                    console.log('Video play failed:', e);
                    if (playBtn) {
                        playBtn.style.display = 'flex';
                    }
                });
                
                videoElement.style.display = 'block';
                
                videoElement.onended = () => {
                    if (playBtn) {
                        playBtn.classList.remove('fa-pause');
                        playBtn.classList.add('fa-play');
                        playBtn.parentElement.style.display = 'flex';
                        videoElement.style.display = 'none';
                    }
                };
            } else {
                videoElement.pause();
                if (playBtn) {
                    playBtn.classList.remove('fa-pause');
                    playBtn.classList.add('fa-play');
                    playBtn.parentElement.style.display = 'flex';
                }
            }
        }

        // Open Image Modal - FIXED for full screen
        function openImageModal(filename, src) {
            const img = imageModal.querySelector('img');
            img.src = src;
            img.alt = filename;
            imageModal.classList.add('active');
        }

        // Download File
        function downloadFile(filename, content) {
            const link = document.createElement('a');
            link.href = content;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Helper Functions
        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // Initialize the app
        init();
    </script>
</body>
</html>